<!doctype html>
<html lang="en" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-lang="dashboard_title">لوحة التحكم</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="sidebar"></div>
  <div id="topbar"></div>

  <main class="container">
    <section class="cards">
      <div class="card">
        <h3 data-lang="vehicles_count">المركبات</h3>
        <p id="vehiclesCount">0</p>
      </div>
      <div class="card">
        <h3 data-lang="drivers_count">السائقون</h3>
        <p id="driversCount">0</p>
      </div>
      <div class="card">
        <h3 data-lang="movements_count">الحركات</h3>
        <p id="movementsCount">0</p>
      </div>
    </section>

    <section class="recent">
      <h2 data-lang="recent_movements">أحدث الحركات</h2>
      <table class="table" id="recentTable">
        <thead>
          <tr>
            <th data-lang="col_vehicle">المركبة</th>
            <th data-lang="col_driver">السائق</th>
            <th data-lang="col_from">من</th>
            <th data-lang="col_to">إلى</th>
            <th data-lang="col_time">الوقت</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script src="firebase.js"></script>
  <script src="session.js"></script>
  <script src="roles.js"></script>
  <script src="ui.js"></script>
  <script src="lang.js"></script>
  <script>
    ensureAuthRedirect(); // from session.js

    async function loadDashboard() {
      const vehicles = await readOnce('vehicles') || {};
      const drivers = await readOnce('drivers') || {};
      const movements = await readOnce('movements') || {};

      document.getElementById('vehiclesCount').textContent = Object.keys(vehicles).length;
      document.getElementById('driversCount').textContent = Object.keys(drivers).length;
      document.getElementById('movementsCount').textContent = Object.keys(movements).length;

      const recentTbody = document.querySelector('#recentTable tbody');
      recentTbody.innerHTML = '';
      const arr = Object.values(movements).sort((a,b)=> (b.timestamp||0)-(a.timestamp||0)).slice(0,10);
      arr.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(m.vehicleName || m.vehicleId || '')}</td>
          <td>${escapeHtml(m.driverName || m.driverId || '')}</td>
          <td>${escapeHtml(m.from || '')}</td>
          <td>${escapeHtml(m.to || '')}</td>
          <td>${new Date(m.timestamp||0).toLocaleString()}</td>
        `;
        recentTbody.appendChild(tr);
      });
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    // init
    applyTranslations();
    loadDashboard();
  </script>
</body>
</html>
