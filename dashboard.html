<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة التحكم</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <div id="sidebar"></div>
  <div id="topbar"></div>

  <main class="page-content">

    <h1>لوحة التحكم</h1>

    <!-- الإحصائيات -->
    <div class="stats-grid">

      <div class="stat-card">
        <h3>عدد المركبات</h3>
        <div class="stat-number" id="statVehicles">0</div>
      </div>

      <div class="stat-card">
        <h3>عدد السائقين</h3>
        <div class="stat-number" id="statDrivers">0</div>
      </div>

      <div class="stat-card">
        <h3>الحركات النشطة</h3>
        <div class="stat-number" id="statActive">0</div>
      </div>

      <div class="stat-card">
        <h3>سجلات الصيانة</h3>
        <div class="stat-number" id="statMaintenance">0</div>
      </div>

    </div>

    <!-- آخر الحركات -->
    <div class="table-card">
      <h2>آخر الحركات</h2>
      <table class="table">
        <thead>
          <tr>
            <th>المركبة</th>
            <th>السائق</th>
            <th>الوجهة</th>
            <th>الوقت</th>
          </tr>
        </thead>
        <tbody id="recentMovements"></tbody>
      </table>
    </div>

    <!-- آخر الإشعارات -->
    <div class="table-card">
      <h2>آخر الإشعارات</h2>
      <table class="table">
        <thead>
          <tr>
            <th>العنوان</th>
            <th>الفئة</th>
            <th>التاريخ</th>
          </tr>
        </thead>
        <tbody id="recentNotifications"></tbody>
      </table>
    </div>

  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script src="firebase.js"></script>
  <script src="session.js"></script>
  <script src="permissions.js"></script>

  <script>
    protectPage("view_dashboard");

    // تحميل الواجهة
    fetch("sidebar.html").then(r => r.text()).then(html => document.getElementById("sidebar").innerHTML = html);
    fetch("topbar.html").then(r => r.text()).then(html => document.getElementById("topbar").innerHTML = html);

    // إحصائيات
    readData("vehicles", data => {
      document.getElementById("statVehicles").textContent = data ? Object.keys(data).length : 0;
    });

    readData("drivers", data => {
      document.getElementById("statDrivers").textContent = data ? Object.keys(data).length : 0;
    });

    readData("movements", data => {
      if (!data) return;

      const list = Object.values(data);
      const active = list.filter(m => !m.end).length;
      document.getElementById("statActive").textContent = active;

      const recent = list.slice(-5).reverse();
      document.getElementById("recentMovements").innerHTML =
        recent.map(m => `
          <tr>
            <td>${m.vehicle}</td>
            <td>${m.driver}</td>
            <td>${m.destination}</td>
            <td>${m.start}</td>
          </tr>
        `).join("");
    });

    readData("maintenance", data => {
      document.getElementById("statMaintenance").textContent = data ? Object.keys(data).length : 0;
    });

    readData("notifications", data => {
      if (!data) return;

      const list = Object.values(data)
        .sort((a, b) => b.date - a.date)
        .slice(0, 5);

      document.getElementById("recentNotifications").innerHTML =
        list.map(n => `
          <tr>
            <td>${n.title}</td>
            <td><span class="badge badge-${n.type}">${n.type}</span></td>
            <td>${new Date(n.date).toLocaleString("ar-AE")}</td>
          </tr>
        `).join("");
    });
  </script>

</body>
</html>
