<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-lang="messaging_page">الرسائل</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="sidebar"></div>
  <div id="topbar"></div>

  <main class="container messaging">
    <aside class="contacts">
      <h3 data-lang="contacts">المستخدمون</h3>
      <ul id="contactsList"></ul>
    </aside>

    <section class="chat">
      <div class="chat-header">
        <h3 id="chatWith">—</h3>
      </div>
      <div class="chat-body" id="chatBody"></div>
      <div class="chat-input">
        <input id="messageInput" placeholder="" data-lang-placeholder="message_placeholder" />
        <button id="sendMsg" class="btn primary" data-lang="send">إرسال</button>
      </div>
    </section>
  </main>

  <script src="firebase.js"></script>
  <script src="session.js"></script>
  <script src="ui.js"></script>
  <script src="lang.js"></script>
  <script>
    ensureAuthRedirect();
    let currentUser = null;
    let currentChatUserId = null;

    firebaseAuthOnChange(async (user)=>{
      currentUser = user;
      await loadContacts();
    });

    async function loadContacts(){
      const users = await readOnce('users') || {};
      const ul = document.getElementById('contactsList');
      ul.innerHTML = '';
      Object.entries(users).forEach(([id,u])=>{
        const li = document.createElement('li');
        li.innerHTML = `<button class="contact-btn" data-id="${id}">${escapeHtml(u.name||u.email)}</button>`;
        ul.appendChild(li);
      });
    }

    document.getElementById('contactsList').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      currentChatUserId = btn.dataset.id;
      document.getElementById('chatWith').textContent = btn.textContent;
      loadChat();
    });

    async function loadChat(){
      if(!currentUser || !currentChatUserId) return;
      const msgs = await readOnce('messages') || {};
      const arr = Object.values(msgs).filter(m =>
        (m.senderId===currentUser.uid && m.receiverId===currentChatUserId) ||
        (m.senderId===currentChatUserId && m.receiverId===currentUser.uid)
      ).sort((a,b)=> (a.timestamp||0)-(b.timestamp||0));
      const body = document.getElementById('chatBody');
      body.innerHTML = '';
      arr.forEach(m=>{
        const div = document.createElement('div');
        div.className = 'msg ' + (m.senderId===currentUser.uid ? 'out' : 'in');
        div.innerHTML = `<div class="bubble">${escapeHtml(m.text)}<div class="time">${new Date(m.timestamp||0).toLocaleTimeString()}</div></div>`;
        body.appendChild(div);
      });
      body.scrollTop = body.scrollHeight;
    }

    document.getElementById('sendMsg').addEventListener('click', async ()=>{
      const text = document.getElementById('messageInput').value.trim();
      if(!text || !currentChatUserId || !currentUser) return;
      const obj = { senderId: currentUser.uid, receiverId: currentChatUserId, text, timestamp: Date.now() };
      await pushData('messages', obj);
      document.getElementById('messageInput').value = '';
      loadChat();
    });

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    applyTranslations();
  </script>
</body>
</html>
