<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إدارة المستخدمين</title>

  <style>
    body { margin: 0; font-family: sans-serif; direction: rtl; background: #f5f5f5; }

    .sidebar {
      width: 220px; background: #1e1e2f; color: white;
      height: 100vh; position: fixed; top: 0; right: 0; padding-top: 20px;
    }
    .sidebar-menu { list-style: none; padding: 0; }
    .sidebar-menu li { margin: 10px 0; }
    .sidebar-menu a {
      color: white; text-decoration: none; padding: 10px 20px; display: block;
    }
    .sidebar-menu a:hover { background: #33334d; }

    .topbar {
      height: 50px; background: #ffffff; display: flex; align-items: center;
      justify-content: space-between; padding: 0 15px; margin-right: 220px;
      border-bottom: 1px solid #ddd;
    }

    .content { margin-right: 220px; padding: 20px; }

    table {
      width: 100%; border-collapse: collapse; background: white;
    }
    th, td {
      padding: 12px; border-bottom: 1px solid #ddd; text-align: right;
    }
    th { background: #f0f0f0; }

    button {
      padding: 6px 12px; border: none; background: #1e1e2f;
      color: white; cursor: pointer; border-radius: 4px;
    }
    button:hover { background: #33334d; }

    .add-box {
      background: white; padding: 20px; margin-bottom: 20px;
      border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    input, select {
      padding: 8px; width: 200px; margin-left: 10px;
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="dashboard.html">الداشبورد</a></li>
      <li><a href="vehicles.html">المركبات</a></li>
      <li><a href="drivers.html">السائقين</a></li>
      <li><a href="maintenance.html">الصيانة</a></li>
      <li><a href="documents.html">الوثائق</a></li>
      <li><a href="users.html">المستخدمين</a></li>
      <li><a href="settings.html">الإعدادات</a></li>
      <li><a href="#" id="logoutBtn">تسجيل الخروج</a></li>
    </ul>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div>إدارة المستخدمين</div>
    <div id="username-display"></div>
  </div>

  <!-- Content -->
  <div class="content">

    <div class="add-box">
      <h3>إضافة مستخدم جديد</h3>

      <input id="email" type="email" placeholder="البريد الإلكتروني">
      <input id="password" type="password" placeholder="كلمة المرور">
      <input id="name" type="text" placeholder="الاسم">
      <select id="role">
        <option value="admin">مدير</option>
        <option value="user">مستخدم</option>
      </select>

      <button id="addUserBtn">إضافة</button>
    </div>

    <h3>قائمة المستخدمين</h3>

    <table>
      <thead>
        <tr>
          <th>الاسم</th>
          <th>البريد</th>
          <th>الدور</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="users-table"></tbody>
    </table>

  </div>

  <!-- Scripts -->
  <script type="module">
    import {
      auth,
      db,
      signOut,
      createUserWithEmailAndPassword,
      ref,
      set,
      onValue,
      remove
    } from "./firebase.js";

    // تسجيل الخروج
    document.getElementById("logoutBtn").onclick = () => {
      signOut(auth).then(() => location.href = "login.html");
    };

    // إضافة مستخدم
    document.getElementById("addUserBtn").onclick = async () => {
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value.trim();
      const name = document.getElementById("name").value.trim();
      const role = document.getElementById("role").value;

      if (!email || !password || !name) {
        alert("يرجى تعبئة جميع الحقول");
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        const uid = cred.user.uid;

        await set(ref(db, "users/" + uid), {
          email,
          name,
          role,
          created_at: Date.now()
        });

        alert("تمت إضافة المستخدم بنجاح");
      } catch (err) {
        alert("خطأ: " + err.message);
      }
    };

    // تحميل المستخدمين
    onValue(ref(db, "users"), snap => {
      const table = document.getElementById("users-table");
      table.innerHTML = "";

      snap.forEach(child => {
        const user = child.val();
        const uid = child.key;

        table.innerHTML += `
          <tr>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td>
              <button onclick="deleteUser('${uid}')">حذف</button>
            </td>
          </tr>
        `;
      });
    });

    // حذف مستخدم
    window.deleteUser = (uid) => {
      if (!confirm("هل أنت متأكد من الحذف؟")) return;
      remove(ref(db, "users/" + uid));
      alert("تم حذف المستخدم");
    };
  </script>

  <script type="module" src="session.js"></script>
  <script type="module" src="permissions.js"></script>

</body>
</html>
