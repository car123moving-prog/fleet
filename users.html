<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إدارة المستخدمين</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>

  <div id="sidebar"></div>
  <div id="topbar"></div>

  <main class="page-content">

    <h1>إدارة المستخدمين</h1>

    <div class="page-header">
      <button class="btn primary" onclick="openUserForm()">+ إضافة مستخدم</button>
    </div>

    <div class="table-tools">
      <input id="searchInput" type="text" placeholder="بحث..." oninput="applySearch()" />
    </div>

    <div class="table-card">
      <table class="table">
        <thead>
          <tr>
            <th>البريد الإلكتروني</th>
            <th>الدور</th>
            <th>إجراءات</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="pagination" class="pagination"></div>

  </main>

  <!-- نافذة إضافة / تعديل مستخدم -->
  <div id="userModal" class="modal hidden">
    <div class="modal-content">
      <h2 id="modalTitle">إضافة مستخدم</h2>

      <label>البريد الإلكتروني</label>
      <input id="u_email" type="email">

      <label>كلمة المرور</label>
      <input id="u_password" type="password">

      <label>الدور</label>
      <select id="u_role">
        <option value="admin">مدير النظام</option>
        <option value="manager">مدير</option>
        <option value="operations">العمليات</option>
        <option value="maintenance">الصيانة</option>
        <option value="viewer">عرض فقط</option>
      </select>

      <div class="modal-actions">
        <button class="btn primary" onclick="saveUser()">حفظ</button>
        <button class="btn" onclick="closeUserForm()">إلغاء</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script src="firebase.js"></script>
  <script src="session.js"></script>
  <script src="permissions.js"></script>

  <script>
    protectPage("manage_users");

    let fullData = [];
    let filteredData = [];
    let pageSize = 8;
    let currentPage = 1;

    let editId = null;

    // تحميل الواجهة
    fetch("sidebar.html").then(r => r.text()).then(html => document.getElementById("sidebar").innerHTML = html);
    fetch("topbar.html").then(r => r.text()).then(html => document.getElementById("topbar").innerHTML = html);

    // تحميل المستخدمين
    readData("users", data => {
      if (!data) return;

      fullData = Object.entries(data).map(([id, u]) => ({ id, ...u }));
      filteredData = fullData;

      renderTable();
    });

    function generateRow(item) {
      return `
        <tr>
          <td>${item.email}</td>
          <td><span class="badge badge-${item.role}">${item.role}</span></td>
          <td>
            <button class="btn small" onclick="editUser('${item.id}', '${item.email}', '${item.role}')">تعديل</button>
            <button class="btn small danger" onclick="deleteUser('${item.id}')">حذف</button>
          </td>
        </tr>
      `;
    }

    function renderTable() {
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageItems = filteredData.slice(start, end);

      document.getElementById("tableBody").innerHTML = pageItems.map(generateRow).join("");
      renderPagination();
    }

    function renderPagination() {
      const pages = Math.ceil(filteredData.length / pageSize);
      const container = document.getElementById("pagination");
      container.innerHTML = "";

      for (let i = 1; i <= pages; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        if (i === currentPage) btn.classList.add("active");
        btn.onclick = () => { currentPage = i; renderTable(); };
        container.appendChild(btn);
      }
    }

    function applySearch() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      filteredData = fullData.filter(item =>
        JSON.stringify(item).toLowerCase().includes(q)
      );
      currentPage = 1;
      renderTable();
    }

    function openUserForm() {
      editId = null;
      document.getElementById("modalTitle").textContent = "إضافة مستخدم";
      document.getElementById("u_email").value = "";
      document.getElementById("u_password").value = "";
      document.getElementById("u_role").value = "viewer";
      document.getElementById("userModal").classList.remove("hidden");
    }

    function closeUserForm() {
      document.getElementById("userModal").classList.add("hidden");
    }

    async function saveUser() {
      const email = document.getElementById("u_email").value.trim();
      const password = document.getElementById("u_password").value.trim();
      const role = document.getElementById("u_role").value;

      if (!email || (!editId && !password)) {
        alert("الرجاء إدخال البيانات");
        return;
      }

      if (editId) {
        await updateData("users/" + editId, { email, role });
      } else {
        const userCred = await auth.createUserWithEmailAndPassword(email, password);
        await updateData("users/" + userCred.user.uid, { email, role });
      }

      closeUserForm();
    }

    async function editUser(id, email, role) {
      editId = id;
      document.getElementById("modalTitle").textContent = "تعديل مستخدم";
      document.getElementById("u_email").value = email;
      document.getElementById("u_password").value = "";
      document.getElementById("u_role").value = role;
      document.getElementById("userModal").classList.remove("hidden");
    }

    async function deleteUser(id) {
      if (!confirm("هل أنت متأكد من الحذف؟")) return;
      await deleteData("users/" + id);
    }
  </script>

</body>
</html>
