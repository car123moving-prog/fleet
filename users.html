<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-lang="users_page">المستخدمون</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="sidebar"></div>
  <div id="topbar"></div>

  <main class="container">
    <header class="page-header">
      <h1 data-lang="users_page">المستخدمون</h1>
      <div>
        <button id="addUserBtn" class="btn primary" data-lang="add_user">إضافة مستخدم</button>
      </div>
    </header>

    <section>
      <table class="table" id="usersTable">
        <thead>
          <tr>
            <th data-lang="col_id">ID</th>
            <th data-lang="col_name">الاسم</th>
            <th data-lang="col_email">البريد</th>
            <th data-lang="col_role">الدور</th>
            <th data-lang="col_actions">إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <h3 id="modalTitle" data-lang="add_user">إضافة مستخدم</h3>
      <div class="form-group">
        <label data-lang="user_name">الاسم</label>
        <input id="userName" />
      </div>
      <div class="form-group">
        <label data-lang="user_email">البريد</label>
        <input id="userEmail" type="email" />
      </div>
      <div class="form-group">
        <label data-lang="user_role">الدور</label>
        <select id="userRole">
          <option value="admin">Admin</option>
          <option value="manager">Manager</option>
          <option value="user">User</option>
        </select>
      </div>
      <div class="form-actions">
        <button id="saveUser" class="btn primary" data-lang="save">حفظ</button>
        <button id="cancelModal" class="btn" data-lang="cancel">إلغاء</button>
      </div>
    </div>
  </div>

  <script src="firebase.js"></script>
  <script src="session.js"></script>
  <script src="ui.js"></script>
  <script src="lang.js"></script>
  <script>
    ensureAuthRedirect();

    const modal = document.getElementById('modal');
    document.getElementById('addUserBtn').addEventListener('click', ()=> {
      modal.classList.remove('hidden');
      document.getElementById('userName').value = '';
      document.getElementById('userEmail').value = '';
      document.getElementById('userRole').value = 'user';
    });
    document.getElementById('cancelModal').addEventListener('click', ()=> modal.classList.add('hidden'));

    document.getElementById('saveUser').addEventListener('click', async ()=>{
      const name = document.getElementById('userName').value.trim();
      const email = document.getElementById('userEmail').value.trim();
      const role = document.getElementById('userRole').value;
      if(!email || !name){ alert('Fill required'); return; }
      // Create user record in users node (authentication should be handled separately)
      const obj = { name, email, role, timestamp: Date.now() };
      await pushData('users', obj);
      modal.classList.add('hidden');
      loadUsers();
    });

    async function loadUsers(){
      const users = await readOnce('users') || {};
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      Object.entries(users).forEach(([id,u])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(id)}</td>
          <td>${escapeHtml(u.name)}</td>
          <td>${escapeHtml(u.email)}</td>
          <td>${escapeHtml(u.role)}</td>
          <td>
            <button class="btn small" data-id="${id}" data-action="edit" data-lang="edit">تعديل</button>
            <button class="btn small danger" data-id="${id}" data-action="delete" data-lang="delete">حذف</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      applyTranslations();
    }

    document.querySelector('#usersTable tbody').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if(action==='delete'){
        if(!confirm('تأكيد الحذف؟')) return;
        await deleteData(`users/${id}`);
        loadUsers();
      } else if(action==='edit'){
        const u = (await readOnce(`users/${id}`)) || {};
        document.getElementById('userName').value = u.name || '';
        document.getElementById('userEmail').value = u.email || '';
        document.getElementById('userRole').value = u.role || 'user';
        modal.classList.remove('hidden');
        document.getElementById('saveUser').onclick = async ()=>{
          const name = document.getElementById('userName').value.trim();
          const email = document.getElementById('userEmail').value.trim();
          const role = document.getElementById('userRole').value;
          await updateData(`users/${id}`, { name, email, role, updatedAt: Date.now() });
          modal.classList.add('hidden');
          loadUsers();
        };
      }
    });

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    applyTranslations();
    loadUsers();
  </script>
</body>
</html>
