<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>إدارة الصيانة</title>

  <style>
    body { margin: 0; font-family: sans-serif; direction: rtl; background: #f5f5f5; }

    .sidebar {
      width: 220px; background: #1e1e2f; color: white;
      height: 100vh; position: fixed; top: 0; right: 0; padding-top: 20px;
    }
    .sidebar-menu { list-style: none; padding: 0; }
    .sidebar-menu li { margin: 10px 0; }
    .sidebar-menu a {
      color: white; text-decoration: none; padding: 10px 20px; display: block;
    }
    .sidebar-menu a:hover { background: #33334d; }

    .topbar {
      height: 50px; background: #ffffff; display: flex; align-items: center;
      justify-content: space-between; padding: 0 15px; margin-right: 220px;
      border-bottom: 1px solid #ddd;
    }

    .content { margin-right: 220px; padding: 20px; }

    table {
      width: 100%; border-collapse: collapse; background: white;
    }
    th, td {
      padding: 12px; border-bottom: 1px solid #ddd; text-align: right;
    }
    th { background: #f0f0f0; }

    button {
      padding: 6px 12px; border: none; background: #1e1e2f;
      color: white; cursor: pointer; border-radius: 4px;
    }
    button:hover { background: #33334d; }

    .add-box {
      background: white; padding: 20px; margin-bottom: 20px;
      border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    input, select {
      padding: 8px; width: 200px; margin-left: 10px;
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <ul class="sidebar-menu">
      <li><a href="dashboard.html">الداشبورد</a></li>
      <li><a href="vehicles.html">المركبات</a></li>
      <li><a href="drivers.html">السائقين</a></li>
      <li><a href="maintenance.html">الصيانة</a></li>
      <li><a href="documents.html">الوثائق</a></li>
      <li><a href="users.html">المستخدمين</a></li>
      <li><a href="settings.html">الإعدادات</a></li>
      <li><a href="#" id="logoutBtn">تسجيل الخروج</a></li>
    </ul>
  </div>

  <!-- Topbar -->
  <div class="topbar">
    <div>إدارة الصيانة</div>
    <div id="username-display"></div>
  </div>

  <!-- Content -->
  <div class="content">

    <div class="add-box">
      <h3>إضافة سجل صيانة جديد</h3>

      <select id="vehicle">
        <option value="">اختر المركبة</option>
      </select>

      <input id="type" type="text" placeholder="نوع الصيانة">
      <input id="cost" type="number" placeholder="التكلفة">
      <input id="date" type="date">

      <button id="addMaintenanceBtn">إضافة</button>
    </div>

    <h3>سجلات الصيانة</h3>

    <table>
      <thead>
        <tr>
          <th>المركبة</th>
          <th>نوع الصيانة</th>
          <th>التكلفة</th>
          <th>التاريخ</th>
          <th>إجراءات</th>
        </tr>
      </thead>
      <tbody id="maintenance-table"></tbody>
    </table>

  </div>

  <!-- Scripts -->
  <script type="module">
    import {
      auth,
      db,
      signOut,
      ref,
      set,
      onValue,
      remove
    } from "./firebase.js";

    // تسجيل الخروج
    document.getElementById("logoutBtn").onclick = () => {
      signOut(auth).then(() => location.href = "login.html");
    };

    // تحميل المركبات في القائمة
    onValue(ref(db, "vehicles"), snap => {
      const select = document.getElementById("vehicle");
      select.innerHTML = `<option value="">اختر المركبة</option>`;

      snap.forEach(child => {
        const v = child.val();
        const id = child.key;
        select.innerHTML += `<option value="${id}">${v.plate} - ${v.model}</option>`;
      });
    });

    // إضافة سجل صيانة
    document.getElementById("addMaintenanceBtn").onclick = () => {
      const vehicle = document.getElementById("vehicle").value;
      const type = document.getElementById("type").value.trim();
      const cost = document.getElementById("cost").value.trim();
      const date = document.getElementById("date").value;

      if (!vehicle || !type || !cost || !date) {
        alert("يرجى تعبئة جميع الحقول");
        return;
      }

      const id = Date.now();

      set(ref(db, "maintenance/" + id), {
        vehicle,
        type,
        cost,
        date,
        created_at: Date.now()
      });

      alert("تمت إضافة سجل الصيانة بنجاح");
    };

    // تحميل السجلات
    onValue(ref(db, "maintenance"), snap => {
      const table = document.getElementById("maintenance-table");
      table.innerHTML = "";

      snap.forEach(child => {
        const m = child.val();
        const id = child.key;

        table.innerHTML += `
          <tr>
            <td>${m.vehicle}</td>
            <td>${m.type}</td>
            <td>${m.cost}</td>
            <td>${m.date}</td>
            <td>
              <button onclick="deleteMaintenance('${id}')">حذف</button>
            </td>
          </tr>
        `;
      });
    });

    // حذف سجل
    window.deleteMaintenance = (id) => {
      if (!confirm("هل أنت متأكد من الحذف؟")) return;
      remove(ref(db, "maintenance/" + id));
      alert("تم حذف السجل");
    };
  </script>

  <script type="module" src="session.js"></script>
  <script type="module" src="permissions.js"></script>

</body>
</html>
