<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title data-lang="maintenance_page">الصيانة</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="sidebar"></div>
  <div id="topbar"></div>

  <main class="container">
    <header class="page-header">
      <h1 data-lang="maintenance_page">الصيانة</h1>
      <div>
        <button id="addMaintBtn" class="btn primary" data-lang="add_maintenance">إضافة سجل صيانة</button>
      </div>
    </header>

    <section>
      <table class="table" id="maintTable">
        <thead>
          <tr>
            <th data-lang="col_id">ID</th>
            <th data-lang="col_vehicle">المركبة</th>
            <th data-lang="col_desc">الوصف</th>
            <th data-lang="col_cost">التكلفة</th>
            <th data-lang="col_time">الوقت</th>
            <th data-lang="col_actions">إجراءات</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <div id="modal" class="modal hidden">
    <div class="modal-content">
      <h3 id="modalTitle" data-lang="add_maintenance">إضافة سجل صيانة</h3>
      <div class="form-group">
        <label data-lang="select_vehicle">اختر المركبة</label>
        <select id="maintVehicle"></select>
      </div>
      <div class="form-group">
        <label data-lang="maintenance_desc">الوصف</label>
        <input id="maintDesc" />
      </div>
      <div class="form-group">
        <label data-lang="maintenance_cost">التكلفة</label>
        <input id="maintCost" type="number" />
      </div>
      <div class="form-actions">
        <button id="saveMaint" class="btn primary" data-lang="save">حفظ</button>
        <button id="cancelModal" class="btn" data-lang="cancel">إلغاء</button>
      </div>
    </div>
  </div>

  <script src="firebase.js"></script>
  <script src="session.js"></script>
  <script src="ui.js"></script>
  <script src="lang.js"></script>
  <script>
    ensureAuthRedirect();

    const modal = document.getElementById('modal');
    document.getElementById('addMaintBtn').addEventListener('click', async ()=> {
      await populateVehicles();
      modal.classList.remove('hidden');
      document.getElementById('maintDesc').value = '';
      document.getElementById('maintCost').value = '';
    });
    document.getElementById('cancelModal').addEventListener('click', ()=> modal.classList.add('hidden'));

    async function populateVehicles(){
      const vehicles = await readOnce('vehicles') || {};
      const sel = document.getElementById('maintVehicle');
      sel.innerHTML = '';
      Object.entries(vehicles).forEach(([id,v])=>{
        const opt = document.createElement('option'); opt.value = id; opt.textContent = v.name || id; sel.appendChild(opt);
      });
    }

    document.getElementById('saveMaint').addEventListener('click', async ()=>{
      const vehicleId = document.getElementById('maintVehicle').value;
      const desc = document.getElementById('maintDesc').value.trim();
      const cost = parseFloat(document.getElementById('maintCost').value) || 0;
      if(!vehicleId || !desc){ alert('Fill required'); return; }
      const vehicles = await readOnce('vehicles') || {};
      const obj = {
        vehicleId,
        vehicleName: vehicles[vehicleId]?.name || '',
        desc, cost, timestamp: Date.now()
      };
      await pushData('maintenance', obj);
      modal.classList.add('hidden');
      loadMaint();
    });

    async function loadMaint(){
      const items = await readOnce('maintenance') || {};
      const tbody = document.querySelector('#maintTable tbody');
      tbody.innerHTML = '';
      Object.entries(items).sort((a,b)=> (b[1].timestamp||0)-(a[1].timestamp||0)).forEach(([id,m])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(id)}</td>
          <td>${escapeHtml(m.vehicleName || m.vehicleId)}</td>
          <td>${escapeHtml(m.desc)}</td>
          <td>${escapeHtml(m.cost)}</td>
          <td>${new Date(m.timestamp||0).toLocaleString()}</td>
          <td>
            <button class="btn small" data-id="${id}" data-action="delete" data-lang="delete">حذف</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      applyTranslations();
    }

    document.querySelector('#maintTable tbody').addEventListener('click', async (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      if(action==='delete'){
        if(!confirm('تأكيد الحذف؟')) return;
        await deleteData(`maintenance/${id}`);
        loadMaint();
      }
    });

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }

    applyTranslations();
    loadMaint();
  </script>
</body>
</html>
